# FaunaDB Demo App

## Prerequisites

### Set up Schema

// TODO: add FQL shell script file for setting up the schema

### Obtain an Admin API Key
// TODO: add info for getting an API key. It will be needed for running the app. More on that [here](https://app.fauna.com/documentation/howto/crud#obtain-an-admin-api-key)

## Runing the app

## API Reference

### Create a Post
Creates a new Post with an autogenerated Id.

__Request__

```
POST /posts
```

```
Content-type: application/json
{
  "title": "My cat and other marvels",
  "tags": ["pet", "cute"]
}
```

__Response__

```
Status: 201 - Created
```
```
Content-type: application/json
{
  "id": "219871526709625348",
  "title": "My cat and other marvels",
  "tags": ["pet", "cute"]
}
```

### Create several Posts
Creates several Posts within a single requests. The Posts will be persisted in a single transaction as well.

__Request__

```
POST /posts
```

```
Content-type: application/json
[
  {"title": "My cat and other marvels", "tags": ["pet", "cute"]},
  {"title": "Pondering during a commute", "tags": ["commuting"]},
  {"title": "Deep meanings in a latte", "tags": ["coffee"]}
]
```

__Response__

```
Status: 200 - OK
```

```
Content-type: application/json
[
  {
    "id": "219970669169869319",
    "title": "My cat and other marvels",
    "tags": ["pet", "cute"]
  },
  {
    "id": "219970865138237959",
    "title": "Pondering during a commute",
    "tags": ["commuting"]
  },
  {
    "id": "219970873639043587",
    "title": "Deep meanings in a latte",
    "tags": ["coffee"]
  }
]
```

### Retrieve a Post
Retrieves an existent Post for the given Id. If the Post cannot be found, a `404 - Not Found` response is returned.

__Request__

```
GET /posts/{post_id}
```

__Response__

```
Status: 200 - OK
```
```
Content-type: application/json
{
  "id": "219871526709625348",
  "title": "My cat and other marvels",
  "tags": ["pet", "cute"]
}
```

### Retrieve Posts
Retrieves all existent Posts.

__Request__

```
GET /posts
```

__Response__

```
Status: 200 - OK
```

```
Content-type: application/json
[
  {
    "id": "219970669169869319",
    "title": "My cat and other marvels",
    "tags": ["pet", "cute"]
  },
  {
    "id": "219970865138237959",
    "title": "Pondering during a commute",
    "tags": ["commuting"]
  },
  {
    "id": "219970873639043587",
    "title": "Deep meanings in a latte",
    "tags": ["coffee"]
  }
]
```

### Retrieve Posts by Tags
Retrieves all the existent Posts matching the given Tags.

```
GET /posts?tags=pet,coffee
```

```
Content-type: application/json
[
  {
    "id": "219970669169869319",
    "title": "My cat and other marvels",
    "tags": ["pet", "cute"]
  },
  {
    "id": "219970873639043587",
    "title": "Deep meanings in a latte",
    "tags": ["coffee"]
  }
]
```

### Replace a Post
It replaces an existent Post for the given Id with given fields. All fields should be provided in the representation along the request. If optional fields are not provided they will be set as empty. If the Post cannot be found, a `404 - Not Found` response is returned.

__Request__

```
PUT /posts/{post_id}
```

```
Content-type: application/json
{
  "title": "My dog and other marvels"
}
```

__Response__

```
Status: 200 - OK
```
```
Content-type: application/json
{
  "id": "219871526709625348"
  "title": "My dog and other marvels",
  "tags": []
}
```

> INFO: note that as the 'tags' field has not been provided in the request, it has been set as empty.

### Update a Post
Partially updates an existent Post for the given Id with the given fields. Only the subset of the provided fields will be updated. If the Post cannot be found, a `404 - Not Found` response is returned.

__Request__

```
PATCH /posts/{post_id}
```

```
Content-type: application/json
{
  "title": "My dog and other marvels"
}
```

__Response__

```
Status: 200 - OK
```
```
Content-type: application/json
{
  "id": "219871526709625348"
  "title": "My dog and other marvels"
  "tags": ["pet", "cute"]
}
```

> INFO: note that although	 the 'tags' field has not been provided in the request, it has not been modified.

### Delete a Post
Deletes an existent Post for the given Id. If the Post cannot be found, a `404 - Not Found` response is returned.


__Request__

```
DELETE /posts/{post_id}
```

__Response__

```
Status: 200 - OK
```
```
Content-type: application/json
{
  "id": "219871526709625348",
  "title": "My cat and other marvels",
  "tags": ["pet", "cute"]
}
```


## FQL Reference

### Save a Post
If there's no previous Post for the given Id, it creates a new Post using an autogenerated Id and the given data. If there's a Post for the given Id, it replaces its content with the given data.

```scala
Select(
  Value("data"),
  If(
    Exists(Ref(Class("posts"), "1520225686617873")),
    //-- Replace Query
    Replace(
      Ref(Class("posts"), "1520225686617873"), 
      Obj("data" -> Obj("title" -> "My cat and other marvels")))
    )
    //-- Create Query
    Let(
      // Create new instance and extract autogenerated Id
      Seq(
        "id" ->
           Select(
             Path("ref", "id"),
             Create(
               Class(Value("posts")), 
               Obj("data" -> Obj("title" -> "My cat and other marvels")))
           )
         ),
         // Update data with autogenerated Id
         Update(
           Ref(Class("posts"), Var("id")),
           Obj("data" -> Obj("id" -> Var("id")))
         )
       )
  )
)
```

> NOTE: Id is also stored in the data section so that `faunadb.values.Codec` can be used to transform from/into Fauna objects and case classes.

#### References:
* [Create](https://app.fauna.com/documentation/reference/queryapi#create)
* [Replace](https://app.fauna.com/documentation/reference/queryapi#replace)
* [Select](https://app.fauna.com/documentation/reference/queryapi#select)
* [If](https://app.fauna.com/documentation/reference/queryapi#if)
* [Exists](https://app.fauna.com/documentation/reference/queryapi#exists)
* [Let](https://app.fauna.com/documentation/reference/queryapi#let)

### Save several Posts
It saves several Posts within a single transaction. It uses the `Map` function to iterates over a collection of entities and apply the above save query to them.

```scala
Map(
  Arr(Obj("data" -> Obj("title" -> "My cat and other marvels")))),
  Lambda( nextEntity => 
    //-- Save Query goes here
  )
```

#### References:
* [Map](https://app.fauna.com/documentation/reference/queryapi#map)
* [Lambda](https://app.fauna.com/documentation/reference/queryapi#lambda)

### Find a Post
It looks up a Post by its Id and returns its data back. 

```scala
Select(
  Value("data"), 
  Get(Ref(Class("posts"), Value("1520225686617873")))
)
```
#### References:
* [Select](https://app.fauna.com/documentation/reference/queryapi#select)
* [Get](https://app.fauna.com/documentation/reference/queryapi#get)


### Find Posts
It looks up all Posts in the class and returns its data back. First, all Posts Ids are found using the class `Index` together with the `Paginate` function and then its data is looked up using the `Get` function.

```scala
Map(
  SelectAll(
    Path("data", "id"),
    Paginate(
      Match(Index(Value(classIndexName)))
    )
  ),
  Lambda( nextId => 
    Select(
      Value("data"), 
      Get(Ref(Class("posts"), nextId)))
    )
  )
```

#### References:
* [Paginate](https://app.fauna.com/documentation/reference/queryapi#paginate)
* [Match](https://app.fauna.com/documentation/reference/queryapi#matchindexref-terms)
* [SelectAll](https://app.fauna.com/documentation/reference/queryapi#selectall)
* [Map](https://app.fauna.com/documentation/reference/queryapi#map)
* [Lambda](https://app.fauna.com/documentation/reference/queryapi#lambda)
* [Get](https://app.fauna.com/documentation/reference/queryapi#get)